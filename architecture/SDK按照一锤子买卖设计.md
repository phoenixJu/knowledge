微服务可以大体分为三类：读服务、写服务、扣减服务
每种微服务都需要考虑共性问题：SDK如何设计、服务如何部署等
### 对外接口的SDK如何设计
一个微服务包含哪些内容：
1. 对外暴露的接口
2. 消费其他微服务发送的消息
3. 独立部署的微服务代码
4. 依赖的数据库、缓存等持久化组件
5. 依赖的其他微服务
6. 对外发送的消息
总结：外部RPC调用方、MQ消息、读写数据库、调用其他微服务四大组件；也就是上游、本身
   和下游
   
构建微服务这三大部分高效法则：防备上游、做好自己、怀疑下游

### SDK的设计是一锤子买卖
定义新接口需要考虑未来的兼容性，如果接口上线后需要修改，需要花费额外的成本
1. 同时提供两个接口
2. 推动所有上游升级修改到新接口
3. 确认老接口没有流量后，下线老接口

### 如何设计稳固的SDK
原则
1. 增加接口调用鉴权
   你的接口QPS为1w，新调用方可能有10w；接口参数中有一个Map字段，实际最大支持
   100个key，新接入的可能有150个key；SDK的查询可能是ES实现的，有ms级别延迟。
   所以新业务可能不及预期。增加鉴权可以提前进行确认防止意外发生
2. 接口入参要使用对象，而不是原子类型
新增参数参数不需要修改接口签名，并且能向后兼容
   
3. 接口的入参不要Map<string,string>等集合
有灵活性但是劣势很明显：1）难维护。动态文本的key要识别就需要magic num和各种硬
   编码，时间长很快腐朽 2）map是动态的，理论上可以插入成百上千的数据，极端情况下会把微服务打挂，对系统稳定性影响大
   
4. 入参需要增加条件限制和参数校验
写接口不校验：超过数据库长度、手机号和邮件影响业务流转
   读接口不校验：cursor limit太大，like等正则耗时语法，数据库打挂
   
5. 写接口保证幂等
超时重试：唯一标识翻查等
   
6. 接口返回结果需要统一，可以抛异常或者RPCResult的结果包装类。
RPCException和RPCResult各有优势
   
7. 返回的数据必须分页
如果返回内容是List，并且不限制很小的入参大小；查询可能打挂数据库，网络传输时长导致接口性能下降
   因此需要分页
   
8. 所有接口需要根据接口能力前置设置限流

### 消息的消费
1. 消息消费有前置限流。如突增保证消息消费的稳定性
2. 幂等性，防止重复消费对业务的影响
3. 消息消费要参数校验，防止脏数据
   